<!DOCTYPE html>
<html>
<head>
    <title>WebAR Viewer</title>
    <script src="https://aframe.io/releases/1.2.0/aframe.min.js"></script>
    <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js"></script>
    <style>
        body { margin: 0; overflow: hidden; }
        #loading {
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: rgba(0,0,0,0.8);
            color: white;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
    </style>
</head>
<body>
    <div id="loading">
        <h2>Loading AR Experience</h2>
        <p id="status">Initializing...</p>
    </div>

    <a-scene 
        vr-mode-ui="enabled: false"
        arjs="sourceType: webcam; debugUIEnabled: false;"
        renderer="logarithmicDepthBuffer: true;"
    >
        <a-camera>
            <!-- We'll place objects relative to camera -->
        </a-camera>

        <script>
            document.addEventListener('DOMContentLoaded', () => {
                const loading = document.getElementById('loading');
                const status = document.getElementById('status');
                
                try {
                    const urlParams = new URLSearchParams(window.location.search);
                    const data = JSON.parse(decodeURIComponent(urlParams.get('data') || '[]'));
                    
                    if (data.length === 0) {
                        status.textContent = 'No AR data provided';
                        return;
                    }

                    data.forEach((obj, index) => {
                        status.textContent = `Loading object ${index + 1}`;
                        
                        const entity = document.createElement('a-entity');
                        
                        // Set position relative to camera
                        if (obj.position) {
                            entity.setAttribute('position', obj.position);
                        } else {
                            // Default position: 5m in front, 1.5m height
                            entity.setAttribute('position', {
                                x: 0,
                                y: -1.5,
                                z: -5
                            });
                        }

                        // Load model
                        entity.setAttribute('gltf-model', `url(${obj.file_url})`);
                        entity.setAttribute('scale', obj.scale || '0.5 0.5 0.5');
                        
                        // Add distance controls
                        let currentDistance = Math.abs(obj.position?.z || 5);
                        const minDistance = obj.min_distance || 2;
                        const maxDistance = obj.max_distance || 10;
                        
                        // Make draggable for distance adjustment
                        entity.setAttribute('draggable', {
                            distanceStep: 0.1,
                            minDistance: minDistance,
                            maxDistance: maxDistance
                        });

                        // Add label
                        if (obj.title) {
                            const text = document.createElement('a-text');
                            text.setAttribute('value', obj.title);
                            text.setAttribute('position', '0 1.5 0');
                            text.setAttribute('scale', '2 2 2');
                            text.setAttribute('color', 'white');
                            text.setAttribute('align', 'center');
                            entity.appendChild(text);
                        }

                        entity.addEventListener('loaded', () => {
                            loading.style.display = 'none';
                            console.log('Object loaded at:', entity.getAttribute('position'));
                        });

                        document.querySelector('a-scene').appendChild(entity);
                    });
                    
                } catch (e) {
                    status.textContent = `Error: ${e.message}`;
                    console.error(e);
                }
            });
        </script>
    </a-scene>
</body>
</html>
