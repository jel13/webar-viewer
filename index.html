<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <!-- iOS Specific Tags -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>AR Viewer</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            overflow: hidden;
            background-color: #000;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            color: white;
        }

        /* Permission Screen */
        #permission-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            background-color: rgba(0, 0, 0, 0.9);
            z-index: 1000;
            padding: 20px;
            box-sizing: border-box;
        }

        #permission-screen h1 {
            font-size: 24px;
            margin-bottom: 10px;
        }

        #permission-screen p {
            font-size: 16px;
            margin-bottom: 30px;
            max-width: 80%;
        }

        .button {
            padding: 12px 24px;
            background-color: #4285F4;
            color: white;
            border: none;
            border-radius: 25px;
            font-size: 16px;
            cursor: pointer;
            margin: 8px;
            min-width: 200px;
            transition: background-color 0.3s;
        }

        .button:hover {
            background-color: #3367D6;
        }

        .button.secondary {
            background-color: #5F6368;
        }

        /* Loading Screen */
        #loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            background-color: rgba(0, 0, 0, 0.9);
            z-index: 999;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 5px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: #4285F4;
            animation: spin 1s ease-in-out infinite;
            margin-bottom: 20px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        #loading-message {
            margin-top: 20px;
            font-size: 18px;
        }

        /* AR Scene */
        #ar-scene {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: none;
        }

        /* Error Screen */
        #error-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            background-color: rgba(0, 0, 0, 0.9);
            z-index: 998;
            padding: 20px;
        }

        #error-screen h2 {
            color: #FF5252;
            margin-bottom: 15px;
        }

        /* Platform-specific elements */
        .ios-only {
            display: none;
        }

        /* Show iOS-specific help on iOS devices */
        .ios .ios-only {
            display: block;
            margin-top: 20px;
            font-size: 14px;
            color: #AAAAAA;
        }
    </style>
</head>
<body>
    <!-- Permission Screen -->
    <div id="permission-screen">
        <h1>AR Experience</h1>
        <p>This experience requires camera access to work properly. Please allow camera permissions when prompted.</p>
        <button id="start-button" class="button">Start AR Experience</button>
        <button id="settings-button" class="button secondary">Open Settings</button>
        <div class="ios-only">
            <p>On iPhone: Go to Settings > Safari > Camera > Allow</p>
        </div>
    </div>

    <!-- Loading Screen -->
    <div id="loading-screen">
        <div class="spinner"></div>
        <div id="loading-message">Initializing AR...</div>
    </div>

    <!-- AR Scene -->
    <a-scene 
        id="ar-scene"
        vr-mode-ui="enabled: false"
        arjs="sourceType: webcam; debugUIEnabled: false; trackingMethod: best;"
        renderer="logarithmicDepthBuffer: true; precision: high; antialias: true;"
    >
        <a-assets>
            <a-asset-item id="model" src=""></a-asset-item>
        </a-assets>
        
        <a-camera></a-camera>
        
        <a-entity id="ar-model"></a-entity>
    </a-scene>

    <!-- Error Screen -->
    <div id="error-screen">
        <h2>Error Loading AR</h2>
        <p id="error-message"></p>
        <button id="retry-button" class="button">Try Again</button>
    </div>

    <script>
        // Detect iOS
        function isIOS() {
            return /iPad|iPhone|iPod/.test(navigator.userAgent) || 
                  (navigator.platform === 'MacIntel' && navigator.maxTouchPoints > 1);
        }

        // DOM Elements
        const permissionScreen = document.getElementById('permission-screen');
        const loadingScreen = document.getElementById('loading-screen');
        const loadingMessage = document.getElementById('loading-message');
        const arScene = document.getElementById('ar-scene');
        const errorScreen = document.getElementById('error-screen');
        const errorMessage = document.getElementById('error-message');
        const startButton = document.getElementById('start-button');
        const settingsButton = document.getElementById('settings-button');
        const retryButton = document.getElementById('retry-button');

        // Add iOS class if needed
        if (isIOS()) {
            document.body.classList.add('ios');
        }

        // Global variables
        let arModelUrl = '';
        let arModelScale = '1 1 1';
        let arModelPosition = '0 0 -2';

        // Parse URL parameters
        function parseUrlParameters() {
            const urlParams = new URLSearchParams(window.location.search);
            const dataParam = urlParams.get('data');
            
            if (dataParam) {
                try {
                    const arData = JSON.parse(decodeURIComponent(dataParam));
                    if (Array.isArray(arData) && arData.length > 0) {
                        const firstObject = arData[0];
                        arModelUrl = firstObject.file_url || '';
                        arModelScale = firstObject.scale || '1 1 1';
                        arModelPosition = firstObject.position || '0 0 -2';
                    }
                } catch (e) {
                    showError('Invalid AR data parameters');
                }
            }
        }

        // Request camera access
        async function requestCameraAccess() {
            try {
                loadingMessage.textContent = "Requesting camera access...";
                
                const constraints = {
                    video: {
                        facingMode: 'environment',
                        width: { ideal: 1280 },
                        height: { ideal: 720 }
                    }
                };
                
                const stream = await navigator.mediaDevices.getUserMedia(constraints);
                
                // Immediately stop tracks to release camera
                stream.getTracks().forEach(track => track.stop());
                
                return true;
            } catch (error) {
                console.error('Camera error:', error);
                
                let errorMsg = 'Camera access was denied.';
                if (error.name === 'NotAllowedError') {
                    errorMsg = 'Please enable camera permissions in your browser settings.';
                } else if (error.name === 'NotFoundError') {
                    errorMsg = 'No camera found on this device.';
                }
                
                showError(errorMsg);
                return false;
            }
        }

        // Initialize AR scene
        async function initializeAR() {
            loadingScreen.style.display = 'flex';
            loadingMessage.textContent = "Initializing AR engine...";
            
            try {
                // Load AR.js components
                await loadScript('https://aframe.io/releases/1.4.0/aframe.min.js');
                await loadScript('https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar-nft.js');
                
                // Wait for scene to be ready
                const scene = document.querySelector('a-scene');
                
                return new Promise((resolve) => {
                    scene.addEventListener('loaded', () => {
                        loadingMessage.textContent = "AR engine ready";
                        resolve(true);
                    });
                    
                    // Fallback in case loaded event doesn't fire
                    setTimeout(() => resolve(true), 3000);
                });
            } catch (error) {
                console.error('AR initialization error:', error);
                showError('Failed to initialize AR engine');
                return false;
            }
        }

        // Load 3D model
        async function loadModel() {
            if (!arModelUrl) {
                showError('No 3D model URL provided');
                return false;
            }
            
            loadingMessage.textContent = "Loading 3D model...";
            
            try {
                const modelEl = document.querySelector('#model');
                modelEl.src = arModelUrl;
                
                return new Promise((resolve, reject) => {
                    modelEl.addEventListener('loaded', () => {
                        const entity = document.createElement('a-entity');
                        entity.setAttribute('gltf-model', '#model');
                        entity.setAttribute('scale', arModelScale);
                        entity.setAttribute('position', arModelPosition);
                        
                        document.getElementById('ar-model').appendChild(entity);
                        loadingMessage.textContent = "Model loaded";
                        resolve(true);
                    });
                    
                    modelEl.addEventListener('error', () => {
                        reject(new Error('Failed to load 3D model'));
                    });
                    
                    // Timeout if model takes too long
                    setTimeout(() => {
                        reject(new Error('Model loading timed out'));
                    }, 15000);
                });
            } catch (error) {
                console.error('Model loading error:', error);
                showError('Failed to load 3D model');
                return false;
            }
        }

        // Start AR experience
        async function startARExperience() {
            // Hide permission screen, show loading
            permissionScreen.style.display = 'none';
            loadingScreen.style.display = 'flex';
            
            // Step 1: Request camera access
            const cameraAccess = await requestCameraAccess();
            if (!cameraAccess) return;
            
            // Step 2: Initialize AR engine
            const arInitialized = await initializeAR();
            if (!arInitialized) return;
            
            // Step 3: Load 3D model
            const modelLoaded = await loadModel();
            if (!modelLoaded) return;
            
            // Step 4: Show AR scene
            loadingScreen.style.display = 'none';
            arScene.style.display = 'block';
        }

        // Show error screen
        function showError(message) {
            errorMessage.textContent = message;
            loadingScreen.style.display = 'none';
            errorScreen.style.display = 'flex';
        }

        // Load script dynamically
        function loadScript(src) {
            return new Promise((resolve, reject) => {
                const script = document.createElement('script');
                script.src = src;
                script.onload = resolve;
                script.onerror = reject;
                document.head.appendChild(script);
            });
        }

        // Open device settings
        function openSettings() {
            if (isIOS()) {
                alert('Please enable camera access in:\nSettings > Safari > Camera');
            } else {
                // Android/Desktop browsers
                window.open('chrome://settings/content/camera');
            }
        }

        // Event listeners
        startButton.addEventListener('click', startARExperience);
        settingsButton.addEventListener('click', openSettings);
        retryButton.addEventListener('click', () => {
            errorScreen.style.display = 'none';
            permissionScreen.style.display = 'flex';
        });

        // Initialize
        parseUrlParameters();
    </script>
</body>
</html>
