<!DOCTYPE html>
<html>
<head>
    <title>AR Viewer</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <script src="https://aframe.io/releases/1.3.0/aframe.min.js"></script>
    <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js"></script>
    <style>
        body { margin: 0; overflow: hidden; }
        #loading {
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: rgba(0,0,0,0.9);
            color: white;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            font-family: Arial, sans-serif;
        }
        #debug {
            position: fixed;
            bottom: 10px;
            left: 10px;
            background: rgba(0,0,0,0.7);
            color: white;
            padding: 10px;
            border-radius: 5px;
            font-size: 12px;
            z-index: 1001;
            max-height: 30%;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <div id="loading">
        <h2>AR Viewer</h2>
        <p id="status">Initializing...</p>
        <button id="retry-btn" style="display:none; padding: 10px 20px; margin-top: 20px;">Retry</button>
    </div>

    <div id="debug"></div>

    <a-scene 
        vr-mode-ui="enabled: false"
        arjs="sourceType: webcam; debugUIEnabled: true; detectionMode: mono_and_matrix; matrixCodeType: 3x3;"
        renderer="logarithmicDepthBuffer: true; precision: high;"
    >
        <a-camera gps-camera rotation-reader></a-camera>

        <script>
            // Debugging setup
            const debug = document.getElementById('debug');
            const loading = document.getElementById('loading');
            const status = document.getElementById('status');
            const retryBtn = document.getElementById('retry-btn');
            
            function log(message) {
                const entry = document.createElement('div');
                entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
                debug.appendChild(entry);
                debug.scrollTop = debug.scrollHeight;
                console.log(message);
            }

            function updateStatus(message) {
                status.textContent = message;
                log(message);
            }

            function showRetryButton() {
                retryBtn.style.display = 'block';
                retryBtn.onclick = () => {
                    window.location.reload();
                };
            }

            // Main initialization
            document.addEventListener('DOMContentLoaded', () => {
                updateStatus("Starting AR session...");
                
                try {
                    // 1. Parse URL parameters with validation
                    const urlParams = new URLSearchParams(window.location.search);
                    const dataStr = decodeURIComponent(urlParams.get('data') || '[]');
                    
                    let data;
                    try {
                        data = JSON.parse(dataStr);
                    } catch (e) {
                        throw new Error(`Invalid JSON data: ${e.message}`);
                    }

                    if (!Array.isArray(data) || data.length === 0) {
                        throw new Error("No valid AR data provided");
                    }

                    const obj = data[0];
                    
                    // 2. Validate required fields
                    if (!obj.file_url) {
                        throw new Error("Missing file_url in AR data");
                    }
                    
                    // Verify the URL is accessible
                    checkModelUrl(obj.file_url)
                        .then(() => {
                            updateStatus("Model URL verified");
                            initAR(obj);
                        })
                        .catch(e => {
                            throw new Error(`Model URL check failed: ${e.message}`);
                        });

                } catch (e) {
                    updateStatus(`Error: ${e.message}`);
                    log(`ERROR: ${e.stack}`);
                    showRetryButton();
                }
            });

            async function checkModelUrl(url) {
                try {
                    const response = await fetch(url, { method: 'HEAD' });
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}`);
                    }
                    const contentType = response.headers.get('content-type');
                    if (!contentType.includes('model/gltf') && !contentType.includes('application/octet-stream')) {
                        throw new Error(`Invalid content-type: ${contentType}`);
                    }
                } catch (e) {
                    throw new Error(`Model URL inaccessible: ${e.message}`);
                }
            }

            function initAR(obj) {
                const scene = document.querySelector('a-scene');
                const arObject = document.createElement('a-entity');
                arObject.setAttribute('id', 'ar-object');
                arObject.setAttribute('position', '0 1.5 -2');
                scene.appendChild(arObject);

                // Set timeout for model loading (60 seconds)
                const loadTimeout = setTimeout(() => {
                    arObject.removeAttribute('gltf-model');
                    throw new Error("Model loading timed out (60 seconds)");
                }, 60000);

                // Load 3D model with progress events
                arObject.setAttribute('gltf-model', {
                    src: `url(${obj.file_url})`,
                    normalize: true,
                    loader: new THREE.GLTFLoader().setWithCredentials(false),
                    onProgress: (progress) => {
                        updateStatus(`Loading model... ${Math.round(progress.loaded/progress.total*100)}%`);
                    }
                });

                // Model loaded handler
                arObject.addEventListener('model-loaded', (e) => {
                    clearTimeout(loadTimeout);
                    updateStatus("Model loaded - initializing");
                    
                    // Auto-scale with bounds checking
                    const box = new THREE.Box3().setFromObject(e.detail.model);
                    const size = box.getSize(new THREE.Vector3());
                    const maxDim = Math.max(size.x, size.y, size.z);
                    
                    let scale;
                    if (maxDim > 100) {
                        scale = 0.5 / maxDim; // Emergency scaling for huge models
                        log(`Emergency scaling applied: ${scale.toFixed(6)}`);
                    } else if (maxDim < 0.01) {
                        scale = 1 / 0.01; // Scale up tiny models
                        log(`Small model scaling applied: ${scale.toFixed(2)}`);
                    } else {
                        scale = 1 / maxDim;
                    }
                    
                    arObject.setAttribute('scale', `${scale} ${scale} ${scale}`);
                    log(`Final scale: ${scale.toFixed(4)} (original size: ${maxDim.toFixed(2)}m)`);
                    
                    // Add visual bounding box
                    const helper = new THREE.BoxHelper(e.detail.model, 0x00ff00);
                    e.detail.model.add(helper);
                    
                    loading.style.display = 'none';
                });

                // Error handling
                arObject.addEventListener('error', (e) => {
                    clearTimeout(loadTimeout);
                    throw new Error(`Model failed to load: ${e.detail.message}`);
                });
            }

            // Global error handler
            window.addEventListener('error', (e) => {
                updateStatus(`Error: ${e.message}`);
                log(`UNHANDLED ERROR: ${e.error.stack}`);
                showRetryButton();
            });
        </script>
    </a-scene>
</body>
</html>
