<!DOCTYPE html>
<html>
<head>
    <title>AR Viewer</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="mobile-web-app-capable" content="yes">
    <script src="https://aframe.io/releases/1.4.0/aframe.min.js"></script>
    <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar-nft.js"></script>
    <style>
        body { margin: 0; overflow: hidden; background: black; }
        #loading {
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: rgba(0,0,0,0.95);
            color: white;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            font-family: Arial, sans-serif;
        }
        #debug {
            position: fixed;
            bottom: 10px;
            left: 10px;
            background: rgba(0,0,0,0.8);
            color: white;
            padding: 10px;
            border-radius: 5px;
            font-size: 12px;
            z-index: 1001;
            max-height: 30%;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <div id="loading">
        <h2>AR Experience</h2>
        <p id="status">Initializing...</p>
    </div>

    <div id="debug"></div>

    <a-scene 
        vr-mode-ui="enabled: false"
        arjs="trackingMethod: best;
              sourceType: webcam;
              debugUIEnabled: true;
              trackingBackend: webarf;
              detectionMode: mono_and_matrix;
              matrixCodeType: 3x3;
              cameraParametersUrl: https://raw.githack.com/AR-js-org/AR.js/master/data/data/camera_para.dat"
        renderer="logarithmicDepthBuffer: true; precision: high; antialias: true"
        stats
    >
        <a-assets>
            <a-asset-item id="fallback-obj" src="https://cdn.jsdelivr.net/gh/donmccurdy/aframe-extras@master/assets/models/wooden-crate/wooden-crate.gltf"></a-asset-item>
        </a-assets>

        <a-camera 
            gps-camera 
            rotation-reader
            position="0 0 0"
            look-controls="enabled: true"
            wasd-controls="enabled: false">
        </a-camera>

        <a-entity id="ar-object" position="0 1.5 -2"></a-entity>

        <script>
            const debug = document.getElementById('debug');
            const loading = document.getElementById('loading');
            const status = document.getElementById('status');

            function log(message, isError = false) {
                const entry = document.createElement('div');
                entry.textContent = [${new Date().toLocaleTimeString()}] ${message};
                entry.style.color = isError ? '#ff6b6b' : '#ffffff';
                debug.appendChild(entry);
                debug.scrollTop = debug.scrollHeight;
                console[isError ? 'error' : 'log'](message);
            }

            function updateStatus(message) {
                status.textContent = message;
                log(message);
            }

            // Verify WebGL support
            function hasWebGL() {
                try {
                    const canvas = document.createElement('canvas');
                    return !!window.WebGLRenderingContext && 
                          (canvas.getContext('webgl') || canvas.getContext('experimental-webgl'));
                } catch (e) {
                    return false;
                }
            }

            // Main initialization
            document.addEventListener('DOMContentLoaded', () => {
                updateStatus("Checking requirements...");
                
                if (!hasWebGL()) {
                    log("WebGL not supported", true);
                    status.innerHTML = "WebGL not supported<br>Try with Chrome or Firefox";
                    return;
                }

                updateStatus("Requesting camera...");
                navigator.mediaDevices.getUserMedia({ video: true })
                    .then(() => initAR())
                    .catch(e => {
                        log(Camera error: ${e.message}, true);
                        status.innerHTML = "Camera access denied<br>Please enable camera permissions";
                    });
            });

            function initAR() {
                updateStatus("Initializing AR...");
                const scene = document.querySelector('a-scene');
                const arObject = document.getElementById('ar-object');

                scene.addEventListener('arjs-video-loaded', () => {
                    log("AR.js video initialized");
                    loadModel();
                });

                scene.addEventListener('renderstart', () => {
                    loading.style.display = 'none';
                    log("AR scene rendering");
                });
            }

            function loadModel() {
                updateStatus("Loading model...");
                const arObject = document.getElementById('ar-object');
                
                // Create test object if no model specified
                const box = document.createElement('a-box');
                box.setAttribute('color', 'red');
                box.setAttribute('position', '0 1.5 -2');
                box.setAttribute('scale', '0.5 0.5 0.5');
                arObject.appendChild(box);
                
                log("Default test object created");
            }
        </script>
    </a-scene>
</body>
</html>
