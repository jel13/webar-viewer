<!DOCTYPE html>
<html>
<head>
    <title>WebAR Viewer</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <script src="https://aframe.io/releases/1.3.0/aframe.min.js"></script>
    <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar-nft.js"></script>
    <style>
        body { margin: 0; overflow: hidden; }
        #loading {
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: rgba(0,0,0,0.9);
            color: white;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            font-family: Arial, sans-serif;
        }
        #debug {
            position: fixed;
            bottom: 10px;
            left: 10px;
            background: rgba(0,0,0,0.7);
            color: white;
            padding: 10px;
            border-radius: 5px;
            font-size: 12px;
            z-index: 1001;
        }
    </style>
</head>
<body>
    <div id="loading">
        <h2>AR Viewer</h2>
        <p id="status">Initializing...</p>
        <div id="progress"></div>
    </div>

    <div id="debug"></div>

    <a-scene 
        vr-mode-ui="enabled: false"
        arjs="sourceType: webcam; debugUIEnabled: true; detectionMode: mono_and_matrix; matrixCodeType: 3x3;"
        renderer="logarithmicDepthBuffer: true; precision: high; antialias: true;"
    >
        <a-camera gps-camera rotation-reader></a-camera>

        <a-entity id="ar-object" position="0 0 -2" scale="0.5 0.5 0.5">
            <!-- 3D model will be placed here -->
        </a-entity>

        <script>
            // Debugging setup
            const debug = document.getElementById('debug');
            const loading = document.getElementById('loading');
            const status = document.getElementById('status');
            const progress = document.getElementById('progress');
            
            function log(message) {
                debug.innerHTML += `<div>[${new Date().toLocaleTimeString()}] ${message}</div>`;
                console.log(message);
                debug.scrollTop = debug.scrollHeight;
            }

            function updateStatus(message, showProgress = false) {
                status.textContent = message;
                progress.style.display = showProgress ? 'block' : 'none';
                log(message);
            }

            // Main initialization
            document.addEventListener('DOMContentLoaded', () => {
                updateStatus("Starting AR session...");
                
                try {
                    // 1. Parse URL parameters
                    const urlParams = new URLSearchParams(window.location.search);
                    const data = JSON.parse(decodeURIComponent(urlParams.get('data') || '[]'));
                    
                    if (data.length === 0) {
                        throw new Error("No AR data provided in URL");
                    }

                    const obj = data[0];
                    log(`Loading object: ${JSON.stringify(obj)}`);

                    // 2. Verify camera access
                    navigator.mediaDevices.getUserMedia({ video: true })
                        .then(() => {
                            updateStatus("Camera access granted");
                            initAR(obj);
                        })
                        .catch(e => {
                            throw new Error(`Camera denied: ${e.message}`);
                        });

                } catch (e) {
                    showError(`Initialization failed: ${e.message}`);
                }
            });

            function initAR(obj) {
                updateStatus("Initializing AR...", true);
                const scene = document.querySelector('a-scene');
                const arObject = document.getElementById('ar-object');

                // 3. Load 3D model
                arObject.setAttribute('gltf-model', `url(${obj.file_url})`);
                
                // 4. Set up event listeners
                arObject.addEventListener('model-loaded', () => {
                    updateStatus("Model loaded - detecting surfaces");
                    
                    // Auto-scale the model
                    const box = new THREE.Box3().setFromObject(arObject.object3D);
                    const size = box.getSize(new THREE.Vector3());
                    const maxDim = Math.max(size.x, size.y, size.z);
                    const scale = 1.0 / maxDim;
                    
                    arObject.setAttribute('scale', {
                        x: scale,
                        y: scale,
                        z: scale
                    });
                    
                    log(`Model scaled to ${scale.toFixed(2)} (original size: ${maxDim.toFixed(2)}m)`);
                    
                    // Hide loading after short delay
                    setTimeout(() => {
                        loading.style.display = 'none';
                    }, 1000);
                });

                arObject.addEventListener('error', (e) => {
                    throw new Error(`Model failed to load: ${e.detail.message}`);
                });

                // 5. Handle AR.js events
                scene.addEventListener('arjs-unsupported', () => {
                    throw new Error("AR.js not supported on this device");
                });

                scene.addEventListener('arjs-camera-init', (e) => {
                    log(`AR camera initialized: ${e.detail}`);
                });

                scene.addEventListener('markerFound', (e) => {
                    log("Marker detected");
                });

                scene.addEventListener('markerLost', (e) => {
                    log("Marker lost");
                });
            }

            function showError(message) {
                loading.innerHTML = `
                    <h2 style="color: #ff4444">Error</h2>
                    <p>${message}</p>
                    <button onclick="window.location.reload()" 
                            style="padding: 10px 20px; margin-top: 20px;
                                   background: #444; color: white; border: none; border-radius: 5px;">
                        Try Again
                    </button>
                `;
                log(`ERROR: ${message}`);
            }
        </script>
    </a-scene>
</body>
</html>
