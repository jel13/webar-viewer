<!DOCTYPE html>
<html>
<head>
    <title>WebAR Viewer</title>
    <script src="https://aframe.io/releases/1.2.0/aframe.min.js"></script>
    <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js"></script>
    <style>
        #loading {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            font-family: Arial, sans-serif;
        }
        #loading progress {
            width: 80%;
            margin: 20px;
        }
        #debug-info {
            position: fixed;
            bottom: 10px;
            left: 10px;
            background: rgba(0, 0, 0, 0.5);
            color: white;
            padding: 10px;
            border-radius: 5px;
            font-size: 12px;
            z-index: 1001;
        }
    </style>
</head>
<body>
    <div id="loading">
        <h2>Loading AR Experience</h2>
        <progress value="0" max="100"></progress>
        <p id="status">Initializing...</p>
    </div>
    
    <div id="debug-info"></div>
    
    <a-scene vr-mode-ui="enabled: false" arjs="sourceType: webcam; debugUIEnabled: false;">
  <a-camera gps-camera rotation-reader></a-camera>
  
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const urlParams = new URLSearchParams(window.location.search);
      const data = JSON.parse(decodeURIComponent(urlParams.get('data') || '[]'));
      
      data.forEach(obj => {
        const entity = document.createElement('a-entity');
        
        // Use offset placement if available
        if (obj.offset_x !== undefined) {
          entity.setAttribute('position', {
            x: obj.offset_x,
            y: obj.offset_z || 0, // Height adjustment
            z: obj.offset_y // Note: z and y are swapped in 3D space
          });
        } else {
          // Fallback to GPS placement
          entity.setAttribute('gps-entity-place', `
            latitude: ${obj.latitude};
            longitude: ${obj.longitude};
          `);
        }
        
        // Load model
        entity.setAttribute('gltf-model', `url(${obj.file_url})`);
        entity.setAttribute('scale', obj.scale || '1 1 1');
        entity.setAttribute('look-at', '[gps-camera]');
        
        // Add label if available
        if (obj.title) {
          const text = document.createElement('a-text');
          text.setAttribute('value', obj.title);
          text.setAttribute('position', '0 2 0');
          text.setAttribute('scale', '3 3 3');
          text.setAttribute('color', 'white');
          entity.appendChild(text);
        }
        
        document.querySelector('a-scene').appendChild(entity);
      });
    });
  </script>
</a-scene>
</body>
</html>
